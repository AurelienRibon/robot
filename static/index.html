<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Robots</title>
    <style>
      * {
        margin: 0;
        box-sizing: border-box;
        font-family: sans-serif;
        font-size: 20px;

        /* Disable text selection */
        user-select: none;
        -webkit-user-select: none !important;
      }

      body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100dvh;
        background-color: #ebe4d1;

        /* Disable text selection */
        -webkit-touch-callout: none !important;
      }

      #push {
        width: 200px;
        height: 200px;
        margin-top: 100px;
        background-color: #812f00;
        border-radius: 50%;
      }

      #action {
        color: #868275;
        margin-top: 30px;
        font-size: 16px;
      }

      #text {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 20px;
        color: #6f6f6f;
        background: #fbf4e1;
        box-shadow: 1px 5px 20px 0 #00000021;
        font-weight: 100;
      }

      .spacer {
        flex: 1;
      }

      .push-front {
        width: 200px;
        height: 200px;
        background-color: #e55604;
        border-radius: 50%;
        transform: translateY(-15px);
        transition: all 0.2s ease-in-out;
      }

      .push-front-pushed {
        background-color: #ba4400;
        transform: translateY(-4px);
      }
    </style>
  </head>
  <body>
    <div id="push">
      <div class="push-front"></div>
    </div>
    <div id="action"></div>
    <div class="spacer"></div>
    <div id="text"></div>

    <script type="module">
      import {
        askGpt,
        disableContextMenu,
        recordAudio,
        setupRecorder,
        textToSpeech,
      } from './main.js';

      main();

      async function main() {
        disableContextMenu();
        const recorder = await setupRecorder();

        const pushEl = document.getElementById('push');
        const textEl = document.getElementById('text');
        const actionEl = document.getElementById('action');

        // Check if we can record audio
        if (!navigator.mediaDevices) {
          textEl.innerText = "L'enregistement audio n'est pas supporté par votre navigateur.";
          textEl.style.color = 'red';
          return;
        }

        const chat = [`Tu es le roi du rap. Fais des phrases courtes pour répondre.`];

        pushEl.ontouchstart = async () => {
          pushEl.querySelector('.push-front').classList.add('push-front-pushed');
          actionEl.innerText = 'Enregistrement...';

          await recordAudio(recorder, async (text) => {
            // Show message and register it to the chat
            textEl.innerText = text;
            chat.push(text);

            // Ask GPT for a reply
            actionEl.innerText = 'Attente de la réponse...';
            const reply = await askGpt(chat);

            // Show reply and register it to the chat
            textEl.innerText = reply;
            chat.push(reply);

            // Speak the reply
            actionEl.innerText = 'Conversion en voix...';
            await textToSpeech(reply);

            // Reset
            actionEl.innerText = '';
          });
        };

        pushEl.ontouchend = () => {
          recorder.stop();
          pushEl.querySelector('.push-front').classList.remove('push-front-pushed');
          actionEl.innerText = 'Transcription de la voix...';
        };
      }
    </script>
  </body>
</html>
